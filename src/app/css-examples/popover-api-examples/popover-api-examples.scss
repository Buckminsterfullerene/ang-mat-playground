:host {
  /* Background: Use the highest surface container for floating elements */
  --popover-bg: var(--mat-sys-surface-container-highest);

  /* Text: Use the corresponding 'on-surface' token for guaranteed contrast */
  --popover-text: var(--mat-sys-on-surface);

  /* Text Light: Use 'on-surface-variant' for secondary/de-emphasized text */
  --popover-text-light: var(--mat-sys-on-surface-variant);

  --popover-shadow: var(--app-elevation-3);
  --popover-radius: var(--app-radius-dialog);

  /* Animation Timings */
  --transition-speed: 250ms;
  --transition-easing: cubic-bezier(0.05, 0.7, 0.1, 1.0); /* M3 Emphasized Easing */

  --popover-closed-opacity: var(--app-state-closed);
  --popover-closed-scale: 0.95;

  display: block;
  padding: 1rem;
}

/**
 * SHARED SURFACE PATTERN
 * Used for Modals, Menus, and Dialogs.
 * Placeholder (%) ensures the CSS is grouped rather than duplicated.
 */
%surface-base {
  padding: 1.5rem;
  border: none;
  border-radius: var(--popover-radius);
  background-color: var(--popover-bg);
  color: var(--popover-text);
  box-shadow: var(--popover-shadow);

  /* Ensure the popover respects the theme color-scheme */
  color-scheme: light dark;

  /**
   * allow-discrete: standard to allow 'display' and 'overlay' properties
   * to participate in transitions (essential for Native Popovers/Dialogs).
   */
  transition: opacity var(--transition-speed) var(--transition-easing),
              transform var(--transition-speed) var(--transition-easing),
              overlay var(--transition-speed) allow-discrete,
              display var(--transition-speed) allow-discrete;
}

/**
 * MODALS AND DIALOGS
 * Styling for Popover Modal, Delete Dialog, and Login Dialog.
 */
.popover-modal, .dialog {
  @extend %surface-base;
  max-inline-size: 400px; // Logical 'width'
  inline-size: 90%;
  margin: auto; // Centers native dialogs in viewport

  /* Initial Closed State */
  opacity: var(--popover-closed-opacity);
  transform: scale(var(--popover-closed-scale)) translateY(-10px);

  /* Handles both native [popover] and native <dialog [open]> */
  &:popover-open, &[open] {
    opacity: 1;
    transform: scale(1) translateY(0);

    /**
     * @starting-style: Defines the state the element transitions FROM
     * the moment it is opened.
     */
    @starting-style {
      opacity: var(--popover-closed-opacity);
      transform: scale(var(--popover-closed-scale)) translateY(-10px);
    }

    &::backdrop {
      /*
       M3 Scrim Standard:
       - Uses 'outline' as the anchor for theme-aware neutral color.
       - L (Lightness) forced to 0.05 (5%) for a deep darkening effect.
       - C (Chroma) and H (Hue) derived from the theme to keep the 'temperature' consistent.
       - Opacity 0.4 (40%) is the standard for M3 scrims.
      */
      background: oklch(from var(--mat-sys-outline) 0.05 c h / var(--app-backdrop-opacity));
      backdrop-filter: var(--app-glass-blur);

      @starting-style {
        background: transparent;
        backdrop-filter: var(--app-blur-none);
      }
    }
  }
}

/**
 * ACTION MENU (Native Anchor Positioning)
 */
.menu-popover {
  @extend %surface-base;

  /* Menus typically use a slightly smaller radius than modals */
  border-radius: var(--app-shape-small);

  /* CRITICAL: Must be display: none when closed to prevent overlay blocking */
  display: none;
  flex-direction: column;
  gap: 4px;
  padding: 0.5rem;

  /* Chrome Anchor Logic */
  position-anchor: --menu-trigger;
  inset: auto;
  top: anchor(bottom);
  left: anchor(left);
  margin-block-start: 8px;
  min-inline-size: 180px;

  /* Animation */
  opacity: 0;
  transform: translateY(-8px);
  transition: opacity var(--transition-speed) var(--transition-easing),
              transform var(--transition-speed) var(--transition-easing),
              overlay var(--transition-speed) allow-discrete,
              display var(--transition-speed) allow-discrete;

  &:popover-open {
    display: flex; // Switch to flex when open
    opacity: 1;
    transform: translateY(0);

    @starting-style {
      opacity: 0;
      transform: translateY(-8px);
    }
  }

  /**
   * MENU ITEM STYLES
   * Nested here for clear encapsulation.
   */
  .menu-item {
    /* Reset standard button (pill) styling */
    all: unset;
    display: block;
    box-sizing: border-box;
    inline-size: 100%; // Fill width of menu

    /* List item appearance */
    padding: 0.75rem 1rem;

    /* Use extra-small for tight internal corners */
    border-radius: var(--app-shape-extra-small);
    color: var(--popover-text);
    font-size: 0.9rem;
    cursor: pointer;

    /* Modern interactive hover */
    //transition: background 150ms ease;
    transition: background-color 150ms cubic-bezier(0.4, 0, 0.2, 1);

    &:hover {
      /*
         M3 State Layer (Hover):
         - Use the color of the content (on-surface)
         - Apply 8% opacity (Standard M3 hover state)
         - OKLCH keeps the color perfectly neutral
      */
      background-color: oklch(from var(--mat-sys-on-surface) l c h / var(--app-opacity-hover));
    }

    &:active {
      /* M3 Pressed State: 12% opacity */
      background-color: oklch(from var(--mat-sys-on-surface) l c h / var(--app-opacity-pressed));
    }

    &:focus-visible {
      outline: 2px solid var(--mat-sys-outline);
      outline-offset: -4px;
    }
  }
}

.menu-trigger {
  anchor-name: --menu-trigger;
}

/**
 * TOAST NOTIFICATIONS
 */
#toast-container {
  /*
  pointer-events: 'none' ensures the wrapper doesn't block clicks on the main UI.    This is because the toast button is
  next to the 'Actions' button, and we want to ensure clicks pass through the 'Actions' menu container. This may not be
  needed if used in other pages.  This seems to be a unique case due to the layout of this example.
  */
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 2147483647; // Topmost layer
}

.toast {
  pointer-events: auto; // Re-enable clicks for the toasts themselves
  position: fixed;
  inset: auto; // Reset native popover centering
  inset-inline: 0; // Logical left/right: 0
  margin-inline: auto; // Center horizontally
  inline-size: fit-content;

  padding: 0.75rem 1.5rem;
  /*
     M3 Inverse Surface (2026 Idiomatic):
     - Background: Invert the 'surface' lightness (L).
       If surface is light (~0.98), this becomes dark (~0.2).
     - Color: Invert the 'on-surface' lightness to match.
  */
  background-color: oklch(from var(--mat-sys-surface) calc(1 - l) c h);
  color: oklch(from var(--mat-sys-on-surface) calc(1 - l) c h);

  /* Toasts use the pill-shape full radius */
  border-radius: var(--app-radius-button);
  box-shadow: var(--app-elevation-2);
  border: none;

  // Animation logic using Popover API standards
  opacity: 0;
  transform: translateY(20px);
  transition:
    opacity 300ms var(--transition-easing) allow-discrete,
    transform 300ms var(--transition-easing) allow-discrete,
    display 300ms var(--transition-easing) allow-discrete;

  &:popover-open {
    display: block;
    opacity: 1;
    transform: translateY(0);

    @starting-style {
      opacity: 0;
      transform: translateY(20px);
    }
  }
}

/**
 * BUTTON SYSTEM (Material Design 3 Logic)
 */
.btn {
  /* Base Tokens */
  --btn-bg: var(--mat-sys-secondary-container);
  --btn-on-bg: var(--mat-sys-on-secondary-container);

  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.625rem 1.5rem;
  border-radius: var(--app-radius-button);
  border: none;
  background-color: var(--btn-bg);
  color: var(--btn-on-bg);
  font: var(--mat-sys-label-large); // Use theme typography if available
  font-weight: 500;
  cursor: pointer;
  /* M3 Standard Easing */
  transition:
    background-color 200ms cubic-bezier(0.2, 0, 0, 1),
    transform 150ms cubic-bezier(0.2, 0, 0, 1),
    box-shadow 200ms cubic-bezier(0.2, 0, 0, 1);

  &:hover {
    /**
     * M3 State Layer (Hover):
     * Instead of just lightening, we use OKLCH to mix in a state layer overlay.
     * This ensures correct contrast regardless of Light or Dark mode.
     */
    background-color: oklch(from var(--btn-bg) calc(l + 0.05) c h);
    box-shadow: var(--app-elevation-1);
  }

  &:active {
    transform: scale(0.97);
    background-color: oklch(from var(--btn-bg) calc(l - 0.03) c h);
  }

  &:focus-visible {
    outline: 2px solid var(--mat-sys-primary);
    outline-offset: 2px;
  }

  &.primary {
    --btn-bg: var(--mat-sys-primary);
    --btn-on-bg: var(--mat-sys-on-primary);

    &:hover {
      /* Dark mode requires slightly different hover adjustments;
         relative syntax handles this dynamically. */
      background-color: oklch(from var(--btn-bg) calc(l + 0.06) c h);
    }
  }

  &.danger {
    --btn-bg: var(--mat-sys-error);
    --btn-on-bg: var(--mat-sys-on-error);

    &:hover {
      background-color: oklch(from var(--btn-bg) calc(l + 0.08) c h);
    }

    &:focus-visible {
      outline-color: var(--mat-sys-error);
    }
  }
}

.dialog-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-block-start: 1.5rem;
}

.toolbar {
  display: flex;
  gap: 12px;
  padding: 1rem;
  background: var(--md-sys-color-surface-container);
  /* Use medium radius for containers like toolbars */
  border-radius: var(--app-radius-card);

  /* Subtle elevation to toolbars */
  box-shadow: var(--app-elevation-1);
}

/* TOOLTIP STYLES */
.tooltip {
  /* RESET: Modern Popovers need inset: auto to clear UA centering */
  inset: auto;
  position: fixed;

  /* TETHERING: Glue to the button */
  position-anchor: --trigger-btn;

  /* Modern Positioning: 'top' places it centered above the button */
  /* If 'top' is not supported, 'top: anchor(top)' is the fallback */
  position-area: top;

  /* Add a gap between the button and the tooltip */
  margin: 0 0 8px;

  /*
     M3 Inverse Surface Role:
     - Background: Derived by inverting the theme's surface lightness.
     - Color: Derived by inverting the theme's on-surface lightness.
     - We use OKLCH relative syntax to maintain the theme's hue and chroma.
  */
  background-color: oklch(from var(--mat-sys-surface) calc(1 - l) c h);
  color: oklch(from var(--mat-sys-on-surface) calc(1 - l) c h);
  padding: 8px 16px;
  border-radius: var(--app-radius-tooltip);
  box-shadow: var(--app-elevation-1);
  border: none;
  font-size: 0.875rem;
  pointer-events: none;

  /* Animations */
  opacity: 0;
  transform: translateY(4px);
  transition:
    opacity 200ms cubic-bezier(0.2, 0, 0, 1),
    transform 200ms cubic-bezier(0.2, 0, 0, 1),
    overlay 200ms allow-discrete,
    display 200ms allow-discrete;

  &:popover-open {
    opacity: 1;
    transform: translateY(0);

    @starting-style {
      opacity: 0;
      transform: translateY(4px);
    }
  }
}

